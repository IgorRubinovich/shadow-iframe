<dom-module id="shadow-iframe">
	<style>

		paper-spinner {
			margin : 300px 100px 100px;
			height : 25px;
			width : 25px;
		}

		#viewPort {
			padding : 5px 5px 5px 10px;
		}

		#backdrop {
			background : white;
			opacity  : .7;
			transition : .2s;
		}

		#redirectDialog {
			display: flex;
			flex-direction: column;
		}
		#dialogContent {
			display: flex;
			flex: 1;
			overflow: auto;
		}
	</style>
	<template>
	
		<div id="viewPortWrapper">
			<div id="viewPort">
			</div>
			</div>
		<div id="backdrop" class="fit center">
			<paper-spinner id="spinner"></paper-spinner>
		</div>

		<paper-dialog id="redirectDialog">
			<div id="dialogContent">
			</div>
			<div class="buttons">
				<paper-icon-button icon="cancel" dialog-dismiss></paper-icon-button>
			</div>
		</paper-dialog>

		<!-- Partial loader last-response="{{ content }}" -->
		<iron-ajax
			url="{{ url }}"
			id="contentLoader"
			handle-as="text"
			on-response="urlLoaded"
			on-error="urlLoadedError"
			debounce-duration="300"

			params="{{ urlParams }}"

			last-error="{{ lastError }}"
			verbose=true
		></iron-ajax>

		<!-- Form submitter -->
		<iron-ajax
			url="/"
			method="POST"
			content-type="{{ contentType }}"
			id="formSubmitter"
			handle-as="text"
			on-response="formSubmitted"
			on-error="formSubmitError"
			debounce-duration="300"
			last-response="{{ lastFormResponse }}"
			last-error="{{ lastError }}"
			verbose=true
		></iron-ajax>

	</template>
</dom-module>

<script>
	ShadowIframe = Polymer({
		is : 'shadow-iframe',
		properties : {
			urlParams : {
				type : Object
			},

			content : {
				type : Object,
				value : "",
				notify : true,
				observer : '_contentChanged'
			},
			hijackForm : {
				type : Boolean
			},
			hideSubmit : {
				type : Boolean
			},
			submitUrl : {
				type : String,
				value : "",
				notify: true
			},
			url : {
				type : String,
				value : null,
				notify : true,
				observer : "_urlChanged"
			},
			lastResponse : {
				type : String,
				value : "",
				notify : true
			},
			lastError : {
				type : Object,
				value : "",
				notify : true
			},
			contentType : {
				type : String,
				value : "application/x-www-form-urlencoded",
				notify : true
			},
			routes : {
				type : Array,
				value : []
			},
			isSubmitEnds : {
				type : Boolean,
				value : true
			}
		},

		ready : function() {

			this.submitters = [];

			var that = this;

 			this._firstTime = 0;
 			this._unchanged = false;

			window.onbeforeunload = null;

 			"mousedown,mouseup,keydown,keyup,click".split(',')
 			    .forEach(function(evType)
 			    {
 			     	that.addEventListener(evType, function(e){

						if(e.type == "click" && e.target.tagName == 'A'){
							if(e.target.hasAttribute('open-to-dialog'))
							{
								e.preventDefault();
								e.stopPropagation();

								var dialogUrl = e.target.getAttribute('href');
								this.navigateToDialog(dialogUrl);
							}
						}

						var f = Polymer.dom(that.root).querySelector('form');
						if(!f)
							return;

 			     		if(e.type != "change" && that._firstTime == 0)
 			     		{
 			     			that._formChanged = urlEncodeForm(f);
 			     			that._firstTime = 1;
 			     		}
 						else
 							if(that._firstTime == 1)
 								if(that._formChanged == urlEncodeForm(f))
 									{
 										if(!that._unchanged)
 										{
											window.onbeforeunload = null;
 											that.fire('unchange');
 											that._unchanged = true;
 										}
 									}
 								else
 									{
										window.onbeforeunload = that.confirmExiting;
 										that._unchanged = false;
 										that.fire('formchange');
 									}
 					});
 			    });
		},



		/*ready : function() {
			this.addEventListener('keyup', function(ev) {
				var k = ev.keyCode || ev.which;

				if(k == 8 || k == 13)
				{
					ev.stopImmediatePropagation();
					ev.stopPropagation();
					ev.preventDefault();
				}
			});
		},*/

		confirmExiting : function(e) {
			e = e || window.event;

			var message = "Сделаные Вами изменения будут отменены, если вы уйдете с этой страницы.";

			if(e)
			{
				e.returnValue = message;
			}

			return message;
		},

		formChecker: function(){
			var that = this;
			var validators = this.querySelectorAll('ir-input-validator');
            validators = Array.prototype.filter.call(validators, function(el) { return el != that });
			if(validators && validators.length > 0){
                var valid = true;
                validators.forEach(function(el, i) {
                    el.validate();
                    if(!el.isValid){
                        valid = false;
                        el.hidden = false;
                    }
                });
                if(!valid) return this.prevent = true;

                this.fire("toast", 'Invalid Form');
			}

		},

		_urlChanged : function() {
			if(!this.url)
				this.content = "";
			else
			{
				if(window.onbeforeunload && this.isSubmitEnds)
				{
					var ask = confirm("Сделаные Вами изменения будут отменены, если вы уйдете с этой страницы. Вы действительно хотите уйти с этой страницы?");
					if(ask == false)
						return;
					else
						window.onbeforeunload = null;
				}
				this.setDisplayMode('waiting');
				
				this.cancelDebouncer("view-port-changed");
				this.$.viewPort.removeEventListener("dom-change", this._domChangeListener);
				this._domChangeListener = null;
				console.log('generated request')
				this.$.contentLoader.generateRequest();
			}
		},

		navigateToDialog: function(url){
			var iframe = document.createElement('shadow-iframe');
			this.$.dialogContent.innerHTML = "";

			Polymer.dom(this.$.dialogContent).appendChild(iframe);
			Polymer.dom.flush();

			iframe.addEventListener('rendered', function() {
				this.$.redirectDialog.center();
				this.$.redirectDialog.notifyResize();
				this.$.redirectDialog.open();
				this.$.redirectDialog.addEventListener('iron-overlay-opened', function(ev) {
					this.$.redirectDialog.style.zIndex = ev.target.style.zIndex;
				}.bind(this));
			}.bind(this));

			iframe.navigate(url);
		},

		navigate : function(url) {
			if(url == this.url)
				this.url = "";

			this.set('url', url);
		},

		_contentChanged : function() {
			this._firstTime = 0;
			this._unchanged = false;
			
			console.log('content changed');
			
			this._contentObserver =
				Polymer.dom(this.$.viewPort).observeNodes(this.contentObserverCallback.bind(this));
			
			// this is hopefully a relic to be removed. this.async(function() { // be a little more graceful to disconnected observers

			Polymer.dom(this.$.viewPort).innerHTML = this.content;
			
			if(!this._domChangeListener) { 
				this._domChangeListener = this._viewPortChangedDebounced.bind(this);
				this.$.viewPort.addEventListener("dom-change", this._domChangeListener);
			}
			this._viewPortChangedDebounced(); // we do this twice (second time from dom-change) so that complex templates can force an update with "dom-change"
			
			Polymer.dom.flush();
		},

		
		contentObserverCallback : function(info) {
			this.cancelDebouncer("content-dom-changed");
			this.debounce("content-dom-changed", this.contentObserverCallbackDebounced.bind(this, event), 250);
		},
		contentObserverCallbackDebounced : function() {
			Polymer.dom(this.$.viewPort).unobserveNodes(this._contentObserver);
			this.fire('rendered');
			console.log('rendered')
		},

		_viewPortChangedDebounced : function(event) {
			this.cancelDebouncer("view-port-changed");
			this.debounce("view-port-changed", this._viewPortChanged.bind(this, event), 250);
		},
		_viewPortChanged : function(event) {
			this.$.viewPort.removeEventListener("dom-change", this._domChangeListener);
			this._domChangeListener = null;
			
			var viewPort = this.$.viewPort;
			
			this.form = viewPort.querySelector("form");
			var submitters = viewPort.querySelectorAll("[type='submit']")

			if(this.hideSubmit || this.hijackForm)
				submitters.forEach(function(el) {
					if(el.__bound) return;
					el.__bound = true;

					if(this.hideSubmit)
						el.style.visibility = 'hidden';
					if(this.hijackForm)
						el.addEventListener('click', function(ev) { this.onSubmit(ev); }.bind(this) );
				}.bind(this));

			if(this.form)
			{
				var s = document.createElement('button');
				s.type = "submit";
				s.style.display = "none";
				s.addEventListener('click', function(ev) { this.onSubmit(ev); }.bind(this));
				Polymer.dom(this.form).appendChild(s);
				this.submitter = s;

				this.form.addEventListener('submit', function(ev) {
					if(!this.isSubmitInProgress)
						ev.preventDefault();
					this.isSubmitInProgress = false;
				});
			}

			var scripts = viewPort.querySelectorAll('script');
				for (var i=0; i<scripts.length; i++)
				{
					if (scripts[i].nodeName != 'SCRIPT')
				    	throw new Error("swapScript requires script");
				    var clone = document.createElement('script');
				  	clone.appendChild( document.createTextNode(scripts[i].textContent));
				 	scripts[i].parentNode.insertBefore(clone, scripts[i]);
				  	scripts[i].parentNode.removeChild(scripts[i]);
				}

				var templates = Polymer.dom(viewPort).querySelectorAll('template');
				for(var j = 0; j < templates.length; j++)
					this.injectBoundHTML(templates[j]);

			//viewPort.removeEventListener("dom-change", this._viewPortChanged);

			this.fire('ready');
		},


		injectBoundHTML : function(element) {
		    var template = element.cloneNode(false);
		    var doc = template.content.ownerDocument;
		    var fragment = doc.createDocumentFragment();
		    while (element.content.firstChild || element.firstChild) {
		    	if(element.firstChild)
		    		fragment.appendChild(element.firstChild);
		    	else
		    		if(element.content.firstChild)
			    		fragment.appendChild(element.content.firstChild);

		    }
		    template.content.appendChild(fragment);
		    element.content.appendChild(Polymer.Base.instanceTemplate(template));

		    if(element.fire)
		    	element.fire('dom-change');
		},

		submit : function(url, method, form) {

			console.log("submit!");

			if(this.isSubmitInProgress)
				return;

			this._form = this.form;

			if(form)
				this._form = form;

			if(url && this._form)
				this._form.action = url;

			this.isSubmitInProgress = true; // extra safety against duplicate submissions
			this.httpMethod = method;

			if(this.submitter && !form)
				this.submitter.click();
			else
				this.onSubmit();
		},

		onSubmitterClick : function(ev) {
			ev.detail.preventDefault(); // remember this is a wrapped event
		},

		onSubmit : function(ev) {

			console.log("onSubmit!");

			var button;
			this.prevent = false;
			var evObj;

			window.onbeforeunload = null;
			this.isSubmitEnds = false;

			this.formChecker();

			if(!this._form)
				this._form = this.form;

			if(ev)
			{
				button = ev.currentTarget;
				ev.preventDefault();

				if(ev.keyCode == 13) {
					ev.preventDefault();
					return false;
				};
			};

			if(this.prevent)
				return;

			evDetailObj = {
				form : this._form,
				preventDefault : function() {
					prevent = true;
				},
				submitUrl : this._form.action,
				originalEvent : ev
			};

			if(button && button.hasAttribute('redirect-to-dialog'))
			{
				var redirectUrl = button.getAttribute('submit-url');
				var iframe = document.createElement('shadow-iframe');

				iframe.addEventListener('submit-complete', function() {
					//this.$.redirectDialog.center();
					this.$.redirectDialog.notifyResize();
					this.$.redirectDialog.open();
					this.$.redirectDialog.addEventListener('iron-overlay-opened', function(ev) {
						this.$.redirectDialog.style.zIndex = ev.target.style.zIndex;
					}.bind(this));
				}.bind(this));

				this.$.dialogContent.innerHTML = "";

				Polymer.dom(this.$.dialogContent).appendChild(iframe);
				Polymer.dom.flush();				

				iframe.form = this.form;
				iframe.submitUrl = redirectUrl;
				iframe.submit();

				return;
			}				

			this._evDetailObj = evDetailObj;

			this.fire('submit', evDetailObj);

			this.$.formSubmitter.body = urlEncodeForm(this._form);
			if(this.submitUrl.length > 0)
				this.$.formSubmitter.url = this.submitUrl;
			else
				this.$.formSubmitter.url = evDetailObj.submitUrl;

			if(this.httpMethod)
				this.$.formSubmitter.method = this.httpMethod.toUpperCase();
			else
				this.$.formSubmitter.method = "POST";

			this.$.formSubmitter.generateRequest();

			this.setDisplayMode('waiting');

			console.log('submitting form');
		},

		formSubmitted : function(ev) {
			var parser, path, pre, isNavigated;

			console.log("formSubmitted!");

			parser = document.createElement('a'); // a brilliant method from https://gist.github.com/jlong/2428561
			parser.href = this._form.action;
			path = parser.pathname;

			this.isSubmitInProgress = false;
			this.httpMethod = null;
			this.fire('submit-complete', this.lastFormResponse);

			this._evDetailObj.response = this.lastFormResponse;

			this.fire('submit-complete-routing', this._evDetailObj);

			for(i = 0; i < this.routes.length; i++)
			{
				pre = new RegExp(this.routes[i].from);
				if(pre.test(path))
				{
					isNavigated = true;
					this.navigate(path.replace(pre, this.routes[i].to));
				}
			}

			if(!isNavigated && this.lastFormResponse)
				this.content = this.lastFormResponse;

			this._evDetailObj = null;

			window.onbeforeunload = null;
			this.isSubmitEnds = true;

			this.setDisplayMode('ready');

			this._form = null;
		},

		formSubmitError : function(ev) {
			this.lastError.status = ev.target.lastRequest.xhr.status;
			this.isSubmitInProgress = false;
			this.httpMethod = null;

			this.fire('iframe-error', { error : this.lastError, retry : function() {
				this.$.formSubmitter.generateRequest();
			}.bind(this)});
		},

		urlLoadedError : function(ev) {
			//this.content = "<pre>" + this.lastError.error + "</pre>";

			this.lastError.status = ev.target.lastRequest.xhr.status;

			this.fire('iframe-error', { error : this.lastError, retry : function() {
				this.$.contentLoader.generateRequest();
			}.bind(this)});

			this.fire("error");
			this.setDisplayMode('ready');
		},

		urlLoaded : function(ev) {
			this.fire('loaded');
			this.setDisplayMode('ready');

			//this.content = "";
			this.set('content',  ev.detail.response);
		},

		setDisplayMode : function(mode) {
			this.mode = mode;
			this.$.spinner.active = mode == 'waiting';
			this.$.backdrop.style.display = this.$.spinner.active ? 'block' : 'none';
			//this.$.viewPort.style.visibility = this.$.spinner.active ? 'none' : 'block';
		},
	});

	function urlEncodeForm(form) {
		var i = -1, res = [];
		while(++i < form.length)
			if(form[i].type == "checkbox")
				res.push(form[i].name + "=" + encodeURIComponent(form[i].checked));
			else if (form[i].name)
				res.push(form[i].name + "=" + encodeURIComponent(form[i].value));

		return res.join("&");
	}
</script>
